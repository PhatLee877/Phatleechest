repeat task.wait() until game:IsLoaded()

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local ActivityRemote = ReplicatedStorage
    :WaitForChild("Modules")
    :WaitForChild("Net")
    :WaitForChild("RE/OnEventServiceActivity")

local CommF = ReplicatedStorage
    :WaitForChild("Remotes")
    :WaitForChild("CommF_")

-- 1. báo click GUI
ActivityRemote:FireServer("TeamSelect/Team/Marines")

task.wait(0.2)

-- 2. set team thật
CommF:InvokeServer("SetTeam", "Marines")

-- ================== SERVICES ==================
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

local PlaceId = game.PlaceId
local JobId = game.JobId

local REJOIN_CODE = [[
    loadstring(game:HttpGet("https://raw.githubusercontent.com/PhatLee877/Phatleechest/refs/heads/main/tween"))()
]]

pcall(function()
    player.Kicked:Connect(function(reason)
        warn("Bị kick | Lý do:", reason or "Unknown")

        queue_on_teleport = REJOIN_CODE
        task.wait(0.5)

        TeleportService:Teleport(PlaceId, player)
    end)
end)
-- ================== CONFIG ==================
local CHEST_LIMIT = 25

local TWEEN_SPEED = 600
local TP_OFFSET = Vector3.new(0, 3, 0)

-- anti stuck
local STUCK_TIME_LIMIT = 1.2
local STUCK_MOVE_LIMIT = 1.5
local SAFE_OFFSET = Vector3.new(0, 12, 0)

-- ================== STATE ==================
local chestCount = 0
local visitedServers = visitedServers or {}

-- ================== UTILS ==================
local function getChestNumber(name)
    return tonumber(string.match(name, "%d+")) or 0
end

local function hasTouchInterest(part)
    for _, v in ipairs(part:GetDescendants()) do
        if v:IsA("TouchTransmitter") then
            return true
        end
    end
    return false
end

-- ================== SERVER HOP ==================
local function serverHop()
    local servers = {}

    local success, req = pcall(function()
        return game:HttpGet(
            "https://games.roblox.com/v1/games/"
            .. PlaceId ..
            "/servers/Public?sortOrder=Desc&limit=100&excludeFullGames=true"
        )
    end)

    if success then
        local body = HttpService:JSONDecode(req)
        if body and body.data then
            for _, v in next, body.data do
                if type(v) == "table"
                and tonumber(v.playing)
                and tonumber(v.maxPlayers)
                and v.playing < v.maxPlayers
                and v.id ~= JobId
                and not table.find(visitedServers, v.id) then
                    table.insert(servers, v.id)
                end
            end
        end
    end

    if #servers == 0 then
        warn("Không còn server để hop.")
        return
    end

    local chosen = servers[math.random(#servers)]
    table.insert(visitedServers, chosen)

    local code = [[
        local visitedServers = ]] .. HttpService:JSONEncode(visitedServers) .. [[
        loadstring(game:HttpGet("https://raw.githubusercontent.com/PhatLee877/Phatleechest/refs/heads/main/tweem"))()
    ]]

    queue_on_teleport = code
    TeleportService:TeleportToPlaceInstance(PlaceId, chosen, player)
end

-- ================== FIND CHESTS (SÂU VÔ HẠN) ==================
local chests = {}

local function scan(inst)
    for _, child in ipairs(inst:GetChildren()) do
        if child:IsA("BasePart")
        and string.find(string.lower(child.Name), "chest")
        and hasTouchInterest(child) then
            table.insert(chests, {
                part = child,
                number = getChestNumber(child.Name)
            })
        end
        scan(child)
    end
end

scan(workspace:WaitForChild("Map"))

-- ================== SORT: SỐ CAO → GẦN ==================
table.sort(chests, function(a, b)
    if a.number ~= b.number then
        return a.number > b.number
    end
    local da = (hrp.Position - a.part.Position).Magnitude
    local db = (hrp.Position - b.part.Position).Magnitude
    return da < db
end)

-- ================== TWEEN + ANTI STUCK ==================
local function tweenToChest(part)
    local distance = (hrp.Position - part.Position).Magnitude
    local time = distance / TWEEN_SPEED

    local tween = TweenService:Create(
        hrp,
        TweenInfo.new(time, Enum.EasingStyle.Linear),
        { CFrame = part.CFrame + TP_OFFSET }
    )

    local lastPos = hrp.Position
    local stuckTime = 0
    local conn

    conn = RunService.Heartbeat:Connect(function(dt)
        local moved = (hrp.Position - lastPos).Magnitude
        if moved < STUCK_MOVE_LIMIT then
            stuckTime += dt
            if stuckTime >= STUCK_TIME_LIMIT then
                tween:Cancel()
                hrp.CFrame = hrp.CFrame + SAFE_OFFSET
                task.wait(0.1)

                distance = (hrp.Position - part.Position).Magnitude
                tween = TweenService:Create(
                    hrp,
                    TweenInfo.new(distance / TWEEN_SPEED, Enum.EasingStyle.Linear),
                    { CFrame = part.CFrame + TP_OFFSET }
                )
                tween:Play()

                stuckTime = 0
                lastPos = hrp.Position
            end
        else
            stuckTime = 0
            lastPos = hrp.Position
        end
    end)

    tween:Play()
    tween.Completed:Wait()

    if conn then
        conn:Disconnect()
    end
end

-- ================== FARM LOOP ==================
for _, chest in ipairs(chests) do
    if chest.part and chest.part.Parent then
        print("Tween tới:", chest.part.Name, "| số:", chest.number)
        tweenToChest(chest.part)

        chestCount += 1
        print("Đã loot:", chestCount)

        if chestCount >= CHEST_LIMIT then
            warn("Đủ "..CHEST_LIMIT.." chest → SERVER HOP")
            serverHop()
            return
        end

        task.wait(0.25)
    end
end

warn("Hết chest trong server → SERVER HOP")
serverHop()
