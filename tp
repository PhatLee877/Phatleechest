repeat task.wait() until game:IsLoaded()

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local ActivityRemote = ReplicatedStorage
    :WaitForChild("Modules")
    :WaitForChild("Net")
    :WaitForChild("RE/OnEventServiceActivity")

local CommF = ReplicatedStorage
    :WaitForChild("Remotes")
    :WaitForChild("CommF_")

-- 1. báo click GUI
ActivityRemote:FireServer("TeamSelect/Team/Marines")

task.wait(0.2)

-- 2. set team thật
CommF:InvokeServer("SetTeam", "Marines")

-- ================== SERVICES ==================
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

local PlaceId = game.PlaceId
local JobId = game.JobId

-- ================== CONFIG ==================
local CHEST_LIMIT = 25

local TP_OFFSET = Vector3.new(0, 4, 0)
local SAFE_OFFSET = Vector3.new(0, 12, 0)
local TP_REPEAT = 3
local TP_DELAY = 0.15

-- ================== STATE ==================
local chestCount = 0
local visitedServers = visitedServers or {}

-- ================== UTILS ==================
local function getChestNumber(name)
    return tonumber(string.match(name, "%d+")) or 0
end

local function hasTouchInterest(part)
    for _, v in ipairs(part:GetDescendants()) do
        if v:IsA("TouchTransmitter") then
            return true
        end
    end
    return false
end

-- ================== SERVER HOP ==================
local function serverHop()
    local servers = {}

    local success, req = pcall(function()
        return game:HttpGet(
            "https://games.roblox.com/v1/games/"
            .. PlaceId ..
            "/servers/Public?sortOrder=Desc&limit=100&excludeFullGames=true"
        )
    end)

    if success then
        local body = HttpService:JSONDecode(req)
        if body and body.data then
            for _, v in next, body.data do
                if type(v) == "table"
                   and tonumber(v.playing)
                   and tonumber(v.maxPlayers)
                   and v.playing < v.maxPlayers
                   and v.id ~= JobId
                   and not table.find(visitedServers, v.id) then
                    table.insert(servers, v.id)
                end
            end
        end
    end

    if #servers == 0 then
        warn("Không còn server để hop.")
        return
    end

    local chosenServer = servers[math.random(1, #servers)]
    table.insert(visitedServers, chosenServer)

    -- Queue script sang server mới
    local code = [[
        local visitedServers = ]] .. HttpService:JSONEncode(visitedServers) .. [[
        loadstring(game:HttpGet("https://raw.githubusercontent.com/PhatLee877/Phatleechest/refs/heads/main/tp"))()
    ]]

    queue_on_teleport = code
    TeleportService:TeleportToPlaceInstance(PlaceId, chosenServer, player)
end

-- ================== FIND CHESTS (SÂU VÔ HẠN) ==================
local chests = {}

local function scan(inst)
    for _, child in ipairs(inst:GetChildren()) do
        if child:IsA("BasePart")
        and string.find(string.lower(child.Name), "chest")
        and hasTouchInterest(child) then
            table.insert(chests, {
                part = child,
                number = getChestNumber(child.Name)
            })
        end
        scan(child)
    end
end

scan(workspace:WaitForChild("Map"))

-- ================== SORT: CHEST CAO → GẦN ==================
table.sort(chests, function(a, b)
    if a.number ~= b.number then
        return a.number > b.number
    end
    local da = (hrp.Position - a.part.Position).Magnitude
    local db = (hrp.Position - b.part.Position).Magnitude
    return da < db
end)

-- ================== TP + ANTI STUCK ==================
local function tpToChest(part)
    for _ = 1, TP_REPEAT do
        if not part or not part.Parent then return end

        hrp.CFrame = part.CFrame + TP_OFFSET
        task.wait(TP_DELAY)

        if (hrp.Position - part.Position).Magnitude > 8 then
            hrp.CFrame = hrp.CFrame + SAFE_OFFSET
            task.wait(0.1)
            hrp.CFrame = part.CFrame + TP_OFFSET
            task.wait(TP_DELAY)
        end
    end
end

-- ================== FARM LOOP ==================
for _, chest in ipairs(chests) do
    if chest.part and chest.part.Parent then
        tpToChest(chest.part)

        chestCount += 1
        print("Đã loot:", chestCount, "chest")

        if chestCount >= CHEST_LIMIT then
            warn("Đủ "..CHEST_LIMIT.." chest → SERVER HOP")
            serverHop()
            return
        end

        task.wait(0.25)
    end
end

warn("Hết chest trong server → SERVER HOP")
serverHop()
